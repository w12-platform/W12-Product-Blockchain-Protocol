# Contribution

 * [Development Setup](#development-setup)
 * [Project structure](#project-structure)
 * [Commands and scripts](#commands-and-scripts)
 * [Testing](#testing)
 * [Migration](#migration)
 * [CI](#ci)
 * [Development](#development)


## Development Setup

You will need install thes tools:

 * [Truffle](https://github.com/trufflesuite/truffle)
 * Development ethereum network. For example: [Ganache UI](https://github.com/trufflesuite/ganache), [Ganache CLI](https://github.com/trufflesuite/ganache-cli)
 * (optional) [solidity-flattener](https://github.com/BlockCatIO/solidity-flattener)
 * (optional) [Solidity compiler](https://solidity.readthedocs.io/en/v0.4.24/installing-solidity.html)
 * Node JS 8+
 * NPM 6+

And then install project dependecies:

```
$ npm install
$ truffle install
```

## Project structure

 * `abi`
    * `<version>` - contains ABIs for all versions of contracts. This ABIs automaticly generated by the script, you will find the script decsription below.
 * `build`
    * `contracts` - where truffle store all compiled contracts.
 * `contracts` - contracts code
 * `docs` - documentation
 * `migration` - truffle migrate scripts
 * `shared` - shared utility code for tests, scripts and other
 * `test` - project tests
 * `config.js` - (IGNORED, not commited) configuration file for CI and devops purposes. 

## Commands and scripts

All of main commands used in development definded in `packages.json` under `scripts` section. Few of the commands described below:

 * `build` - compile contracts and generate ABIs for current version
 * `abi` - generate ABIs for current version
 * `dev-net` - start ethereum local dev network
 * `ci-test` - command used by CI service to run tests
 * `ci-deploy-test-net` - used by CI service to deploy process
 * `estimate-gas` - estimate gas usage for all contracts and print result
 * `gen-release` - generate release changelog and push to github

All utility scripts stored under `shared/scripts` directory.

- `deploy.sh` used to deploy contract
- `generate-abi.js` used to generate ABIs for all contracts of current version, this script uses build result of truffle compile command. ABIs will not be generate if current ABI version of contracts have not diffrent from previosly.

## Testing

Start local network:

```
$ npm run dev-net
```

and then run tests:

```
$ npm run test
```

## Migrations

Migrations could be performed with truffle migrate.

## CI

We use CircleCI to run CI jobs. All CI process cosists of 3 stages:

 1. *Setup*. On this stage CI do setup process: fetch repository, install dependecies and other work.
 2. *Test*. This stage requires to be done Setup stage. On this stage CI do testing job.
 3. *Deploy*. This stage requires to be done Test stage. Run migrate to network. See CI config.

## Development

**Deploying to test network**

Increment the contracts version in `package.json` and send changes to `alpha-release` branche to trigger deploy process. See `deploy-to-test-net.sh` script.

**Deploying to prod network**

TODO

**Notes**

* If you want to skip CI to be triggered add `[ci skip]` tag at any place of your commit message.
* Do not commit truffle compile results (`build/contracts`).
